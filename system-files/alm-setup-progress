#!/bin/bash
# ============================================================================
# ALM Setup Progress Display
# ============================================================================
#
# WHAT THIS SCRIPT DOES:
# - Displays real-time setup progress during first-time device initialization
# - Shows progress bars for Docker installation, image pulls, configuration
# - Only runs during initial setup (not on subsequent logins)
# - Auto-called from bashrc on SSH login
#
# USAGE:
# - Automatically called from .bashrc during first boot
# - Manual usage: /usr/local/bin/alm-setup-progress
#
# DEPLOYMENT:
# - Deployed from public alm-config repository via Puppet
# - Integrated into bashrc for all users (almuser, almadmin, root)
# ============================================================================

set -euo pipefail

# State files
SETUP_COMPLETE_FLAG="/var/lib/alm/setup_complete"
SETUP_STATE_DIR="/var/lib/alm/setup_state"
DOCKER_PULL_LOG="/var/log/alm/docker-pull.log"
PUPPET_LAST_RUN="/opt/puppetlabs/puppet/cache/state/last_run_report.yaml"

# Colors
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly RED='\033[0;31m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m' # No Color

# Progress bar function
progress_bar() {
    local percent=$1
    local width=${2:-50}
    local filled=$((percent * width / 100))
    local empty=$((width - filled))
    local bar=""
    local i

    for ((i=0; i<filled; i++)); do
        bar="${bar}‚ñà"
    done
    for ((i=0; i<empty; i++)); do
        bar="${bar}‚ñë"
    done

    echo -e "[\033[32m${bar}\033[0m] ${percent}%"
}

# Check if setup is complete
is_setup_complete() {
    # Setup is complete if:
    # 1. Flag file exists, OR
    # 2. Docker is installed AND containers are running

    if [ -f "$SETUP_COMPLETE_FLAG" ]; then
        return 0
    fi

    # Check if containers are running (indicates setup complete)
    # Specifically check for main app containers (alm_arm64 or alm_amd64) AND telemetry
    if command -v docker &>/dev/null; then
        local running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null)
        if echo "$running_containers" | grep -q 'alm_arm64\|alm_amd64'; then
            if echo "$running_containers" | grep -q 'alm_telemetry'; then
                # Both main and telemetry containers running = setup complete
                return 0
            fi
        fi
    fi

    return 1
}

# Get overall setup progress percentage
get_setup_progress() {
    local total_steps=6
    local completed=0

    # Step 1: Docker installed
    if command -v docker &>/dev/null; then
        ((completed++))
    fi

    # Step 2: Docker service running
    if systemctl is-active --quiet docker 2>/dev/null; then
        ((completed++))
    fi

    # Step 3: Puppet configured
    if [ -f "/etc/puppetlabs/puppet/puppet.conf" ]; then
        ((completed++))
    fi

    # Step 4: ALM directories created
    if [ -d "/opt/alm" ]; then
        ((completed++))
    fi

    # Step 5: Docker images pulled
    if command -v docker &>/dev/null; then
        if docker images | grep -q 'alm-init\|alm-app'; then
            ((completed++))
        fi
    fi

    # Step 6: Containers running (both main app and telemetry)
    if command -v docker &>/dev/null; then
        local running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null)
        if echo "$running_containers" | grep -q 'alm_arm64\|alm_amd64'; then
            if echo "$running_containers" | grep -q 'alm_telemetry'; then
                ((completed++))
            fi
        fi
    fi

    echo $((completed * 100 / total_steps))
}

# Get current setup step description
get_current_step() {
    if ! command -v docker &>/dev/null; then
        echo "Installing Docker..."
        return
    fi

    if ! systemctl is-active --quiet docker 2>/dev/null; then
        echo "Starting Docker service..."
        return
    fi

    if [ ! -f "/etc/puppetlabs/puppet/puppet.conf" ]; then
        echo "Configuring Puppet agent..."
        return
    fi

    if [ ! -d "/opt/alm" ]; then
        echo "Creating ALM directories..."
        return
    fi

    if command -v docker &>/dev/null; then
        if ! docker images | grep -q 'alm-init\|alm-app'; then
            # Check if actively pulling
            if [ -f "$DOCKER_PULL_LOG" ]; then
                if tail -n 5 "$DOCKER_PULL_LOG" 2>/dev/null | grep -q "Downloading\|Extracting"; then
                    echo "Pulling Docker images (this may take 3-5 minutes)..."
                    return
                fi
            fi
            echo "Waiting for Docker image pull to start..."
            return
        fi
    fi

    if command -v docker &>/dev/null; then
        local running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null)
        # Check if both main and telemetry containers are running
        if echo "$running_containers" | grep -q 'alm_arm64\|alm_amd64'; then
            if echo "$running_containers" | grep -q 'alm_telemetry'; then
                # Both running = setup complete
                echo "Setup complete!"
                return
            fi
        fi
        # If we get here, containers are not fully running yet
        echo "Starting ALM containers..."
        return
    fi

    echo "Setup complete!"
}

# Show detailed docker pull progress if actively pulling
show_docker_pull_progress() {
    if [ ! -f "$DOCKER_PULL_LOG" ]; then
        return
    fi

    # Check if pull is active (within last 10 seconds)
    local log_age=0
    if [ -f "$DOCKER_PULL_LOG" ]; then
        # Use stat -c for Linux (Raspberry Pi), -f for macOS
        log_age=$(( $(date +%s) - $(stat -c %Y "$DOCKER_PULL_LOG" 2>/dev/null || stat -f %m "$DOCKER_PULL_LOG" 2>/dev/null || echo 0) ))
    fi

    if [ "$log_age" -lt 10 ]; then
        # Show last few progress lines
        echo ""
        echo -e "${BLUE}Docker Pull Progress:${NC}"
        tail -n 3 "$DOCKER_PULL_LOG" 2>/dev/null | grep -E "‚¨áÔ∏è|üìÇ|‚úÖ|üíæ" | while read -r line; do
            echo "  $line"
        done
    fi
}

# Display setup progress
display_progress() {
    clear

    cat << "EOF"
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                         ‚ïë
‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ïë
‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ïë
‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù   ‚ïë
‚ïë     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó   ‚ïë
‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ïë
‚ïë     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïë
‚ïë                                                                         ‚ïë
‚ïë                         AUTONOMOUS LOCAL MANAGER                        ‚ïë
‚ïë                                                                         ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF

    echo ""
    local progress=$(get_setup_progress)
    local current_step=$(get_current_step)
    local bar=$(progress_bar "$progress" 60)

    echo -e "${CYAN}Setup Progress:${NC}"
    echo "$bar"
    echo ""
    echo -e "${YELLOW}Current Step:${NC} $current_step"
    echo ""

    # Show detailed progress for docker pulls
    show_docker_pull_progress

    echo ""
    echo -e "${GRAY}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${NC}"
    echo ""

    if [ "$progress" -eq 100 ]; then
        echo -e "${GREEN}‚úÖ Setup Complete!${NC}"
        echo ""
        echo "Your device is now ready. Available commands:"
        echo "  ${BLUE}alm status${NC}   - Check device and container status"
        echo "  ${BLUE}alm logs${NC}     - View container logs"
        echo "  ${BLUE}alm help${NC}     - Show all available commands"
        echo ""

        # Mark setup as complete
        sudo mkdir -p "$(dirname "$SETUP_COMPLETE_FLAG")" 2>/dev/null || true
        sudo touch "$SETUP_COMPLETE_FLAG" 2>/dev/null || true
    else
        echo -e "${YELLOW}‚è≥ Setup in progress...${NC}"
        echo ""
        local time_remaining=$(( (100 - progress) / 20 + 1 ))
        if [ "$time_remaining" -eq 1 ]; then
            echo "Estimated time remaining: 1 minute"
        else
            echo "Estimated time remaining: $time_remaining minutes"
        fi
        echo ""
        echo "You can:"
        echo "  ‚Ä¢ Wait here and watch progress"
        echo "  ‚Ä¢ Log out and check back later (${BLUE}ssh almuser@device-ip${NC})"
        echo "  ‚Ä¢ Monitor detailed logs: ${BLUE}alm pull -f${NC}"
        echo ""
        echo -e "${GRAY}This screen updates automatically. Press Ctrl+C to exit.${NC}"
    fi
}

# Main execution
main() {
    # Skip if setup is already complete
    if is_setup_complete; then
        exit 0
    fi

    # Show progress
    display_progress

    # If not complete, offer to auto-refresh
    if [ "$(get_setup_progress)" -ne 100 ]; then
        echo ""
        read -t 5 -p "Auto-refresh in 5 seconds (or press Enter now)..." || true
        exec "$0" "$@"
    fi
}

# Only run if called directly (not sourced)
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
