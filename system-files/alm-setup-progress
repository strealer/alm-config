#!/bin/bash
# ============================================================================
# ALM Setup Progress Display
# ============================================================================
#
# WHAT THIS SCRIPT DOES:
# - Displays real-time setup progress during first-time device initialization
# - Shows progress bars for Docker installation, image pulls, configuration
# - Only runs during initial setup (not on subsequent logins)
# - Auto-called from bashrc on SSH login
#
# USAGE:
# - Automatically called from .bashrc during first boot
# - Manual usage: /usr/local/bin/alm-setup-progress
#
# DEPLOYMENT:
# - Deployed from public alm-config repository via Puppet
# - Integrated into bashrc for all users (almuser, almadmin, root)
# ============================================================================

set -euo pipefail

# State files
SETUP_COMPLETE_FLAG="/var/lib/alm/setup_complete"
SETUP_STATE_DIR="/var/lib/alm/setup_state"
PUPPET_LAST_RUN="/opt/puppetlabs/puppet/cache/state/last_run_report.yaml"
PUPPET_TRIGGERED_FLAG="/var/lib/alm/puppet_triggered_this_boot"

# Colors
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly RED='\033[0;31m'
readonly GRAY='\033[0;90m'
readonly NC='\033[0m' # No Color

# Check network connectivity (using ping to DNS server)
check_network() {
    if ping -c1 -W2 8.8.8.8 >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

# Check if Puppet is currently running (works for all users)
is_puppet_running() {
    # Method 1: Check for puppet agent process (works for all users)
    if pgrep -f "puppet agent" >/dev/null 2>&1; then
        return 0
    fi
    
    # Method 2: Check lockfile (may not be readable by non-root)
    local lockfile="/opt/puppetlabs/puppet/cache/state/agent_catalog_run.lock"
    if [ -f "$lockfile" ] 2>/dev/null; then
        return 0
    fi
    
    return 1
}

# Trigger Puppet run if needed (only for root user)
# Returns: 0 = triggered or not needed, 1 = no network
trigger_puppet_if_needed() {
    local current_user
    current_user=$(whoami)
    
    # Only root can trigger Puppet
    if [[ "$current_user" != "root" ]]; then
        return 0
    fi
    
    # Skip if already triggered this boot
    if [ -f "$PUPPET_TRIGGERED_FLAG" ]; then
        return 0
    fi
    
    # Check if setup is already complete
    if is_setup_complete; then
        return 0
    fi
    
    # Check network connectivity
    if ! check_network; then
        return 1  # No network
    fi
    
    # Check if Puppet has run successfully recently (last 5 minutes)
    if [ -f "$PUPPET_LAST_RUN" ]; then
        local last_run_time
        last_run_time=$(stat -c %Y "$PUPPET_LAST_RUN" 2>/dev/null || stat -f %m "$PUPPET_LAST_RUN" 2>/dev/null)
        local now
        now=$(date +%s)
        local age=$((now - last_run_time))
        if [ "$age" -lt 300 ]; then
            # Puppet ran recently, no need to trigger
            mkdir -p /var/lib/alm
            touch "$PUPPET_TRIGGERED_FLAG"
            return 0
        fi
    fi
    
    # Trigger Puppet run in background
    echo -e "${YELLOW}Triggering Puppet run...${NC}"
    mkdir -p /var/lib/alm
    touch "$PUPPET_TRIGGERED_FLAG"
    
    # Run Puppet in background so it doesn't block the progress display
    nohup /opt/puppetlabs/bin/puppet agent -t >/var/log/alm/puppet-trigger.log 2>&1 &
    
    return 0
}

# Progress bar function
progress_bar() {
    local percent=$1
    local width=${2:-50}
    local filled=$((percent * width / 100))
    local empty=$((width - filled))
    local bar=""
    local i

    for ((i=0; i<filled; i++)); do
        bar="${bar}█"
    done
    for ((i=0; i<empty; i++)); do
        bar="${bar}░"
    done

    echo -e "[\033[32m${bar}\033[0m] ${percent}%"
}

# Check if setup is complete
is_setup_complete() {
    # Setup is complete if:
    # 1. Flag file exists, OR
    # 2. Port 80 is responding (primary check - works for all users), OR
    # 3. Docker containers running (only for almadmin/root)

    if [ -f "$SETUP_COMPLETE_FLAG" ]; then
        return 0
    fi

    # Primary completion check: nginx serving on port 80
    # This is checked continuously in the monitoring loop and works for all users
    # Try curl first, fall back to wget (more commonly pre-installed)
    if command -v curl &>/dev/null; then
        if curl -f -s -o /dev/null localhost:80 2>/dev/null; then
            return 0
        fi
    elif command -v wget &>/dev/null; then
        if wget -q -O /dev/null --timeout=2 localhost:80 2>/dev/null; then
            return 0
        fi
    fi

    # Secondary check: Docker containers running (only for users with Docker access)
    # Only run Docker commands for almadmin and root
    local current_user
    current_user=$(whoami)
    if [[ "$current_user" == "almadmin" || "$current_user" == "root" ]]; then
        if command -v docker &>/dev/null; then
            local running_containers
            running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null || echo "")
            if echo "$running_containers" | grep -q '^alm$'; then
                if echo "$running_containers" | grep -q 'alm_telemetry'; then
                    return 0
                fi
            fi
        fi
    fi

    return 1
}

# Get overall setup progress percentage
get_setup_progress() {
    local total_steps=6
    local completed=0

    # Step 1: Docker installed
    if command -v docker &>/dev/null; then
        ((completed++))
    fi

    # Step 2: Docker service running
    if systemctl is-active --quiet docker 2>/dev/null; then
        ((completed++))
    fi

    # Step 3: Puppet configured
    if [ -f "/etc/puppetlabs/puppet/puppet.conf" ]; then
        ((completed++))
    fi

    # Step 4: ALM directories created
    if [ -d "/opt/alm" ]; then
        ((completed++))
    fi

    # Step 5: Docker images pulled (check all required images exist)
    # Only check for almadmin and root (requires Docker group access)
    local current_user
    current_user=$(whoami)
    if [[ "$current_user" == "almadmin" || "$current_user" == "root" ]]; then
        if command -v docker &>/dev/null; then
            # Check if all three required images exist locally
            if docker image inspect \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:latest \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:latest \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-telemetry/alm-telemetry:latest \
                >/dev/null 2>&1; then
                ((completed++))
            fi
        fi
    else
        # For almuser: skip this step (no Docker access)
        # Assume progress if Docker service is running
        if systemctl is-active --quiet docker 2>/dev/null; then
            ((completed++))
        fi
    fi

    # Step 6: Containers running (both main app and telemetry)
    # Only check for almadmin and root (requires Docker group access)
    if [[ "$current_user" == "almadmin" || "$current_user" == "root" ]]; then
        if command -v docker &>/dev/null; then
            local running_containers
            running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null || echo "")
            if echo "$running_containers" | grep -q '^alm$'; then
                if echo "$running_containers" | grep -q 'alm_telemetry'; then
                    ((completed++))
                fi
            fi
        fi
    else
        # For almuser: use curl/wget localhost:80 as indicator
        if command -v curl &>/dev/null; then
            if curl -f -s -o /dev/null localhost:80 2>/dev/null; then
                ((completed++))
            fi
        elif command -v wget &>/dev/null; then
            if wget -q -O /dev/null --timeout=2 localhost:80 2>/dev/null; then
                ((completed++))
            fi
        fi
    fi

    echo $((completed * 100 / total_steps))
}

# Get current setup step description
get_current_step() {
    if ! command -v docker &>/dev/null; then
        echo "Installing Docker..."
        return
    fi

    if ! systemctl is-active --quiet docker 2>/dev/null; then
        echo "Starting Docker service..."
        return
    fi

    if [ ! -f "/etc/puppetlabs/puppet/puppet.conf" ]; then
        echo "Configuring Puppet agent..."
        return
    fi

    if [ ! -d "/opt/alm" ]; then
        echo "Creating ALM directories..."
        return
    fi

    # Image and container checks - only for almadmin and root
    local current_user
    current_user=$(whoami)
    if [[ "$current_user" == "almadmin" || "$current_user" == "root" ]]; then
        if command -v docker &>/dev/null; then
            # Check if all required images are pulled
            if ! docker image inspect \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:latest \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:latest \
                europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-telemetry/alm-telemetry:latest \
                >/dev/null 2>&1; then
                echo "Pulling Docker images (this may take 3-5 minutes)..."
                return
            fi
        fi

        if command -v docker &>/dev/null; then
            local running_containers
            running_containers=$(docker ps --format '{{.Names}}' 2>/dev/null || echo "")
            # Check if both main and telemetry containers are running
            if echo "$running_containers" | grep -q '^alm$'; then
                if echo "$running_containers" | grep -q 'alm_telemetry'; then
                    # Both running = setup complete
                    echo "Setup complete!"
                    return
                fi
            fi
            # If we get here, containers are not fully running yet
            echo "Starting ALM containers..."
            return
        fi
    else
        # For almuser: show simplified message
        echo "Finalizing setup (waiting for service to start)..."
        return
    fi

    echo "Setup complete!"
}

# Docker pull progress tracking removed - Puppet handles pulls
# Progress detection now uses simple image existence checks (more reliable)

# Display setup progress
display_progress() {
    clear

    cat << "EOF"
╔═════════════════════════════════════════════════════════════════════════╗
║                                                                         ║
║     ███████╗████████╗██████╗ ███████╗ █████╗ ██╗     ███████╗██████╗    ║
║     ██╔════╝╚══██╔══╝██╔══██╗██╔════╝██╔══██╗██║     ██╔════╝██╔══██╗   ║
║     ███████╗   ██║   ██████╔╝█████╗  ███████║██║     █████╗  ██████╔╝   ║
║     ╚════██║   ██║   ██╔══██╗██╔══╝  ██╔══██║██║     ██╔══╝  ██╔══██╗   ║
║     ███████║   ██║   ██║  ██║███████╗██║  ██║███████╗███████╗██║  ██║   ║
║     ╚══════╝   ╚═╝   ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═╝   ║
║                                                                         ║
║                         AUTONOMOUS LOCAL MANAGER                        ║
║                                                                         ║
╚═════════════════════════════════════════════════════════════════════════╝
EOF

    echo ""
    local progress=$(get_setup_progress)
    local current_step=$(get_current_step)
    local bar=$(progress_bar "$progress" 60)

    echo -e "${CYAN}Setup Progress:${NC}"
    echo "$bar"
    echo ""
    echo -e "${YELLOW}Current Step:${NC} $current_step"
    
    # Show Puppet status if running
    if is_puppet_running; then
        echo -e "${CYAN}  └─ Puppet agent is currently running...${NC}"
    fi
    echo ""
    echo ""
    echo -e "${GRAY}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [ "$progress" -eq 100 ]; then
        echo -e "${GREEN}✅ Setup Complete!${NC}"
        echo ""
        echo "Your device is now ready. Available commands:"
        echo -e "  ${BLUE}alm status${NC}   - Check device and container status"
        echo -e "  ${BLUE}alm logs${NC}     - View container logs"
        echo -e "  ${BLUE}alm help${NC}     - Show all available commands"
        echo ""

        # Setup is complete - rely on container detection, no flag file needed
        # Container detection in is_setup_complete() handles future login checks
    else
        echo -e "${YELLOW}⏳ Setup in progress...${NC}"
        echo ""
        local time_remaining=$(( (100 - progress) / 20 + 1 ))
        if [ "$time_remaining" -eq 1 ]; then
            echo "Estimated time remaining: 1 minute"
        else
            echo "Estimated time remaining: $time_remaining minutes"
        fi
        echo ""
        echo "You can:"
        echo "  • Wait here and watch progress (updates every 3 seconds)"
        echo -e "  • Log out and check back later (${BLUE}ssh almuser@device-ip${NC})"
        echo -e "  • Monitor detailed logs: ${BLUE}alm logs init${NC}"
        echo ""
        echo -e "${GRAY}Press Ctrl+C to exit this monitoring screen${NC}"
    fi
}

# Main execution
main() {
    # Continuous monitoring loop
    # Checks setup completion (including curl localhost:80) every few seconds
    # For almadmin/root: also monitors Docker image pulls and container status
    # For almuser: relies on curl localhost:80 check (no Docker access needed)
    
    local network_warned=false
    local puppet_triggered=false

    while true; do
        # Check if setup is complete
        # This includes curl localhost:80 check (works for all users)
        # and Docker container checks (only for almadmin/root)
        if is_setup_complete; then
            # Show final success screen
            clear
            display_progress
            exit 0
        fi

        # Check network and trigger Puppet if needed (only for root)
        if ! trigger_puppet_if_needed; then
            # No network - show warning
            if [ "$network_warned" = false ]; then
                clear
                cat <<EOF
╔═════════════════════════════════════════════════════════════════════════╗
║                                                                         ║
║     ███████╗████████╗██████╗ ███████╗ █████╗ ██╗     ███████╗██████╗    ║
║     ██╔════╝╚══██╔══╝██╔══██╗██╔════╝██╔══██╗██║     ██╔════╝██╔══██╗   ║
║     ███████╗   ██║   ██████╔╝█████╗  ███████║██║     █████╗  ██████╔╝   ║
║     ╚════██║   ██║   ██╔══██╗██╔══╝  ██╔══██║██║     ██╔══╝  ██╔══██╗   ║
║     ███████║   ██║   ██║  ██║███████╗██║  ██║███████╗███████╗██║  ██║   ║
║     ╚══════╝   ╚═╝   ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚══════╝╚══════╝╚═╝  ╚═╝   ║
║                                                                         ║
║                         AUTONOMOUS LOCAL MANAGER                        ║
║                                                                         ║
╚═════════════════════════════════════════════════════════════════════════╝
EOF
                echo ""
                echo -e "${RED}⚠️  No Network Connection${NC}"
                echo ""
                echo -e "${YELLOW}Please connect this device to the internet:${NC}"
                echo "  • Connect an Ethernet cable, OR"
                echo "  • Configure WiFi using: sudo nmtui"
                echo ""
                echo -e "${GRAY}Checking for network every 5 seconds...${NC}"
                echo -e "${GRAY}Press Ctrl+C to exit${NC}"
                network_warned=true
            fi
            sleep 5
            continue
        fi
        
        # Network is available - reset warning flag
        network_warned=false

        # Show current progress
        clear
        display_progress

        # Wait before checking again (3 seconds)
        # Allow user to exit with Ctrl+C
        sleep 3
    done
}

# Only run if called directly (not sourced)
if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
    main "$@"
fi
