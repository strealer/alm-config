#!/bin/bash
# ============================================================================
# GCP Artifact Registry Docker Login Script
# ============================================================================
#
# WHAT THIS SCRIPT DOES:
# - Authenticates Docker to GCP Artifact Registry using service account credentials
# - Allows container pulls from private europe-west1-docker.pkg.dev registry
# - Gracefully handles missing credentials during initial device setup
#
# DEPLOYMENT:
# - Downloaded from public alm-config repo during pi-gen image build
# - Puppet later deploys actual GCP service account token to /root/.gcp/
# - Token file location: /root/.gcp/docker-gcp-token.json
#
# SECURITY:
# - This script is PUBLIC (no secrets embedded)
# - GCP service account token deployed separately via Puppet (private alm-infra)
# - Only root can read token file (600 permissions)
#
# USAGE:
# - Called automatically by strealer-container.service before docker compose pull
# - Manual usage: sudo /usr/local/bin/docker-login-gcp
# ============================================================================

TOKEN_FILE="/root/.gcp/docker-gcp-token.json"

if [ -f "$TOKEN_FILE" ]; then
    echo "[docker-login-gcp] Authenticating to GCP Artifact Registry..."
    cat "$TOKEN_FILE" | docker login -u _json_key --password-stdin https://europe-west1-docker.pkg.dev
    if [ $? -eq 0 ]; then
        echo "[docker-login-gcp] ✓ Successfully authenticated to GCP Artifact Registry"
        exit 0
    else
        echo "[docker-login-gcp] ✗ Authentication failed"
        exit 1
    fi
else
    echo "[docker-login-gcp] GCP token not found at $TOKEN_FILE"
    echo "[docker-login-gcp] Skipping Docker login (Puppet will configure credentials)"
    echo "[docker-login-gcp] Containers will pull from public registry or use cached images"
    exit 0  # Exit success to allow systemd service to continue
fi
