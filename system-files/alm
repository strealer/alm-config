#!/bin/bash
#
# ALM - Autonomous Local Manager CLI
# Device management tool for Strealer edge computing system
#
# Usage: alm <command> [options]
# Commands: status, logs, restart, reset, help
#
# NOTE: Registration is fully automated - no user interaction needed
#

set -euo pipefail

# Docker command - use sudo only if not running as root
# This ensures commands work both interactively and via SSH as root
if [[ $EUID -eq 0 ]]; then
	DOCKER_CMD="docker"
	DOCKER_COMPOSE_CMD="docker compose"
else
	DOCKER_CMD="sudo docker"
	DOCKER_COMPOSE_CMD="sudo docker compose"
fi

# Puppet command - always use full path since /opt/puppetlabs/bin may not be in PATH
readonly PUPPET_BIN="/opt/puppetlabs/bin/puppet"
readonly PUPPETSERVER_BIN="/opt/puppetlabs/bin/puppetserver"

# Colors for output (use $'...' syntax for escape sequence interpretation)
readonly RED=$'\033[0;31m'
readonly GREEN=$'\033[0;32m'
readonly YELLOW=$'\033[1;33m'
readonly BLUE=$'\033[0;34m'
readonly CYAN=$'\033[0;36m'
readonly NC=$'\033[0m' # No Color

# Helper functions
log_info() {
	echo -e "${BLUE}ℹ${NC} $*"
}

log_success() {
	echo -e "${GREEN}✅${NC} $*"
}

log_warning() {
	echo -e "${YELLOW}⚠${NC} $*"
}

log_error() {
	echo -e "${RED}❌${NC} $*" >&2
}

# Check if container is running via HTTP health check (no docker access needed)
is_container_healthy() {
	local port=$1
	curl -sf --max-time 1 "http://localhost:${port}" >/dev/null 2>&1
}

# Get device IP address
get_device_ip() {
	ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K[0-9.]+' || echo "unknown"
}

# Get architecture
get_architecture() {
	local arch
	arch=$(uname -m)
	case "$arch" in
	aarch64 | arm64) echo "ARM64" ;;
	x86_64 | amd64) echo "AMD64" ;;
	*) echo "$arch" ;;
	esac
}

# Detect container suffix based on architecture
get_container_suffix() {
	local arch
	arch=$(uname -m)
	if [[ "$arch" == "aarch64" ]] || [[ "$arch" == "arm64" ]]; then
		echo "arm64"
	else
		echo "amd64"
	fi
}

# Get main container image checksum (SHA256)
# Always returns 0 to avoid issues with set -e
get_image_checksum() {
	local main_container="alm"

	# Get image ID from running/stopped container
	local image_id
	image_id=$($DOCKER_CMD ps -a --filter "name=^${main_container}$" --format "{{.Image}}" 2>/dev/null) || image_id=""

	if [[ -z "$image_id" ]]; then
		echo "unknown"
		return 0
	fi

	# Get full image digest
	local digest
	digest=$($DOCKER_CMD inspect --format='{{index .RepoDigests 0}}' "$image_id" 2>/dev/null | grep -oP 'sha256:\K[a-f0-9]{64}' || true)

	if [[ -n "$digest" ]]; then
		# Return first 12 characters of SHA256
		echo "${digest:0:12}"
	else
		# Fallback to short image ID
		local short_id
		short_id=$($DOCKER_CMD inspect --format='{{.ID}}' "$image_id" 2>/dev/null | grep -oP 'sha256:\K[a-f0-9]{12}' || true)
		echo "${short_id:-unknown}"
	fi
	return 0
}

#
# Command: alm status
# Show device and container status
#
cmd_status() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm status

Display device information and container status.

Shows:
  • Current container image checksum
  • Device IP address and hostname
  • System architecture (ARM64/AMD64)
  • Docker service status
  • Init container status
  • Main container status
  • Service accessibility

Examples:
  alm status
EOF
		return 0
	fi

	local ip
	local hostname
	local arch
	local checksum

	ip=$(get_device_ip)
	hostname=$(hostname)
	arch=$(get_architecture)
	checksum=$(get_image_checksum)

	echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${NC}"
	echo -e "${CYAN}║${NC}  ${GREEN}ALM Device Status${NC}                                        ${CYAN}║${NC}"
	echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${NC}"
	echo ""

	echo -e "${BLUE}Image Checksum:${NC}"
	echo "  SHA256: $checksum"
	echo ""

	echo -e "${BLUE}Device Information:${NC}"
	echo "  IP Address:   $ip"
	echo "  Hostname:     $hostname"
	echo "  Architecture: $arch"
	echo ""

	echo -e "${BLUE}Docker Service:${NC}"
	if systemctl is-active --quiet docker 2>/dev/null; then
		log_success "Docker is running"
	else
		log_error "Docker is not running"
		echo "  Start with: sudo systemctl start docker"
		return 1
	fi
	echo ""

	echo -e "${BLUE}Container Status:${NC}"

	local init_container="alm_init"
	local main_container="alm"

	# Get container names (avoid grep -Fxq which fails with set -e when no match)
	local container_names
	container_names=$($DOCKER_CMD ps -a --format "{{.Names}}" 2>/dev/null) || container_names=""

	# Check init container (should exit after successful registration)
	if echo "$container_names" | grep -Fxq "$init_container" 2>/dev/null; then
		local init_status
		init_status=$($DOCKER_CMD ps -a --filter "name=^${init_container}$" --format "{{.Status}}" 2>/dev/null) || init_status=""
		if echo "$init_status" | head -n1 | grep -q "Exited (0)" 2>/dev/null; then
			log_success "Init container: Completed successfully"
			echo "    Registration complete, device initialized"
		else
			log_warning "Init container: $init_status"
			echo "    Device may still be registering..."
		fi
	else
		log_info "Init container: Not found (may have been cleaned up)"
	fi

	# Check main container (via HTTP on port 80)
	if echo "$container_names" | grep -Fxq "$main_container" 2>/dev/null; then
		if is_container_healthy 80; then
			log_success "Main container: Running"
			echo "    Port 80: Application service"
			echo ""
			echo -e "${GREEN}Service URL:${NC} http://$ip:80"
		else
			log_warning "Main container: Container exists but HTTP check failed"
			echo "    Device may still be initializing"
			echo "    Check logs: alm logs"
		fi
	else
		log_warning "Main container: Not found"
		echo "    Start containers: alm restart"
	fi

	echo ""
	echo -e "${BLUE}Telemetry Worker:${NC}"
	local telemetry_status
	telemetry_status=$($DOCKER_CMD ps -a --filter "name=^alm_telemetry$" --format "{{.Status}}" 2>/dev/null) || telemetry_status=""
	if [[ -n "$telemetry_status" ]]; then
		if echo "$telemetry_status" | grep -qi "Up"; then
			log_success "Telemetry container: Running"
			echo "    Sends device info every 5 minutes"
		else
			log_warning "Telemetry container: $telemetry_status"
			echo "    Check logs: alm logs telemetry"
		fi
	else
		log_warning "Telemetry container: Not found"
		echo "    Start containers: alm restart"
	fi

	echo ""
}

#
# Command: alm logs
# Follow container logs
#
cmd_logs() {
	local container_type="main"
	local follow=true
	local tail_lines=50

	# Parse arguments
	while [[ $# -gt 0 ]]; do
		case "$1" in
		init | main | telemetry)
			container_type="$1"
			shift
			;;
		--no-follow | -n)
			follow=false
			shift
			;;
		--tail)
			tail_lines="$2"
			shift 2
			;;
		--help | -h)
			cat <<EOF
Usage: alm logs [CONTAINER] [OPTIONS]

Follow container logs in real-time.

Arguments:
  CONTAINER    Container to show logs for: init, main, telemetry (default: main)

Options:
  --no-follow  Show logs without following (exit after display)
  --tail N     Number of lines to show (default: 50)
  --help       Show this help message

Examples:
  alm logs              # Follow main container logs
  alm logs init         # Follow init container logs
  alm logs --tail 100   # Show last 100 lines
  alm logs init -n      # Show init logs without following
EOF
			return 0
			;;
		*)
			log_error "Unknown option: $1"
			echo "Use 'alm logs --help' for usage information"
			return 1
			;;
		esac
	done

	local container_name
	case "$container_type" in
	init)
		container_name="alm_init"
		;;
	telemetry)
		container_name="alm_telemetry"
		;;
	*)
		container_name="alm"
		;;
	esac

	# Check if container exists
	if ! $DOCKER_CMD ps -a --format '{{.Names}}' 2>/dev/null | grep -qx "$container_name"; then
		log_error "Container '$container_name' does not exist"
		echo ""
		echo "This usually means:"
		if [[ "$container_name" == "alm_init" ]]; then
			echo "  • Device setup is still in progress (Puppet running)"
			echo "  • Init container completed and was removed (check 'alm logs' for main container)"
		else
			echo "  • Device setup is still in progress"
			echo "  • Containers haven't been started yet"
		fi
		echo ""
		echo "Run 'alm status' to check current state"
		return 1
	fi

	log_info "Showing logs for: $container_name"
	echo ""

	if [[ "$follow" == true ]]; then
		$DOCKER_CMD logs -f --tail "$tail_lines" "$container_name" 2>&1 || {
			log_error "Could not access container logs (requires sudo/docker access)"
			return 1
		}
	else
		$DOCKER_CMD logs --tail "$tail_lines" "$container_name" 2>&1 || {
			log_error "Could not access container logs (requires sudo/docker access)"
			return 1
		}
	fi
}

#
# Command: alm restart
# Restart ALM containers
#
cmd_restart() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm restart

Restart the ALM containers using Docker Compose.

This will:
  1. Stop all running containers
  2. Start containers based on architecture
  3. Show updated status

Requires: sudo privileges

Examples:
  alm restart
EOF
		return 0
	fi

	log_info "Restarting ALM containers..."
	echo ""

	cd /opt/alm 2>/dev/null || {
		log_error "ALM directory not found at /opt/alm"
		return 1
	}

	log_info "Stopping containers..."
	$DOCKER_COMPOSE_CMD down 2>/dev/null || true

	log_info "Starting containers..."
	# Uses unified service names (multi-arch auto-detection by Docker)
	$DOCKER_COMPOSE_CMD up -d --remove-orphans alm_init alm alm_telemetry

	log_success "Containers restarted successfully"
	echo ""

	log_info "Waiting for containers to start..."
	sleep 5

	echo ""
	cmd_status
}

#
# Command: alm reset
# Reset device to allow fresh registration
#
cmd_reset() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm reset [-y|--yes]

Reset the ALM device to start fresh registration.

${RED}WARNING: This will:${NC}
  1. Stop and remove all containers
  2. Delete all configuration and registration data
  3. Remove Docker volumes
  4. Restart service for fresh automated setup

Options:
  -y, --yes    Skip confirmation prompt

Use this when:
  • Registration is stuck or incomplete
  • Need to re-register the device
  • Want to start configuration from scratch

Requires: sudo privileges

Examples:
  alm reset        # Interactive with confirmation
  alm reset -y     # Skip confirmation (for scripts)
EOF
		return 0
	fi

	local skip_confirm=false
	if [[ "${1:-}" == "-y" ]] || [[ "${1:-}" == "--yes" ]]; then
		skip_confirm=true
	fi

	echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
	echo -e "${RED}║${NC}  ${YELLOW}WARNING: This will delete all ALM data and config${NC}         ${RED}║${NC}"
	echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
	echo ""
	echo "This will:"
	echo "  • Stop all running containers"
	echo "  • Remove all containers and volumes"
	echo "  • Delete registration and configuration data"
	echo "  • Reset device to fresh state"
	echo ""

	if [[ "$skip_confirm" != "true" ]]; then
		read -r -p "Are you sure you want to reset? [y/N]: " response
		if [[ ! "$response" =~ ^[Yy]$ ]]; then
			log_info "Reset cancelled"
			return 0
		fi
	fi

	cd /opt/alm 2>/dev/null || {
		log_error "ALM directory not found at /opt/alm"
		return 1
	}

	echo ""
	log_info "Stopping containers..."
	$DOCKER_COMPOSE_CMD down 2>/dev/null || true

	echo ""
	log_info "Removing containers..."

	# Stop and remove containers (unified names - no architecture suffix)
	$DOCKER_CMD stop "alm_init" 2>/dev/null || true
	$DOCKER_CMD stop "alm" 2>/dev/null || true
	$DOCKER_CMD stop "alm_telemetry" 2>/dev/null || true
	$DOCKER_CMD rm "alm_init" 2>/dev/null || true
	$DOCKER_CMD rm "alm" 2>/dev/null || true
	$DOCKER_CMD rm "alm_telemetry" 2>/dev/null || true

	echo ""
	log_info "Removing Docker volumes..."

	# Remove volumes with docker compose
	$DOCKER_COMPOSE_CMD down -v 2>/dev/null || true

	# Clean up any orphaned volumes
	# shellcheck disable=SC2086 # Word splitting intentional - DOCKER_CMD may be "sudo docker"
	$DOCKER_CMD volume ls -q | grep -E "alm_config|alm_persist" | xargs -r $DOCKER_CMD volume rm 2>/dev/null || true

	echo ""
	log_success "Reset complete!"
	echo ""
	log_info "Starting containers for automated re-registration..."

	# Start containers using docker compose (Puppet manages this normally)
	$DOCKER_COMPOSE_CMD up -d --remove-orphans alm_init alm alm_telemetry

	echo ""
	log_success "Containers started - device is re-registering"
	log_info "Registration happens in background (no user action needed)"
	log_info "Check progress with: alm logs init"
	echo ""
}

#
# Command: alm factory-reset
# Complete reset - clears all state and triggers fresh Puppet setup
#
cmd_factory_reset() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm factory-reset [-y|--yes]

Reset device to a FRESH state and trigger immediate re-setup.

${RED}⚠️  DANGER ZONE - This goes beyond 'alm reset':${NC}
  1. Removes ALL Docker containers, images, and volumes
  2. Clears Docker temp files (fixes corrupted state)
  3. Clears Puppet certificate and agent state
  4. Deletes ALL ALM runtime state and config
  5. Recreates minimal Puppet config and triggers fresh run

Options:
  -y, --yes    Skip confirmation prompt (DANGEROUS!)

${BLUE}What is KEPT:${NC}
  • User accounts (almadmin, almuser, root)
  • SSH authorized_keys
  • Docker installation (cleared but not uninstalled)
  • ALM CLI tool, setup-progress script
  • Basic directory structure (/opt/alm)

After this command:
  • Puppet will immediately start a fresh configuration run
  • Docker images will be re-pulled from registry
  • Containers will be recreated
  • The setup progress screen will show current status

Use this to:
  • Test the full setup experience without rebooting
  • Recover from corrupted Docker/Puppet state
  • Debug initial setup issues

Requires: sudo privileges

Examples:
  alm factory-reset        # Interactive with confirmation
  alm factory-reset -y     # Skip confirmation (DANGEROUS!)
EOF
		return 0
	fi

	local skip_confirm=false
	if [[ "${1:-}" == "-y" ]] || [[ "${1:-}" == "--yes" ]]; then
		skip_confirm=true
	fi

	echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
	echo -e "${RED}║${NC}  ${RED}⚠️  DANGER: FACTORY RESET - CLEARS ALL STATE${NC}              ${RED}║${NC}"
	echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
	echo ""
	echo "This will reset the device by:"
	echo "  • Removing ALL Docker containers, images, and volumes"
	echo "  • Clearing Docker temp files (fixes corrupted state)"
	echo "  • Clearing Puppet certificate and SSL state"
	echo "  • Deleting ALL ALM runtime state and progress files"
	echo "  • Triggering immediate Puppet re-configuration"
	echo ""
	echo -e "${BLUE}Keeping:${NC}"
	echo "  • User accounts and SSH keys"
	echo "  • Docker installation"
	echo "  • ALM CLI and setup-progress script"
	echo ""
	echo -e "${YELLOW}Puppet will start fresh setup immediately after reset.${NC}"
	echo ""

	if [[ "$skip_confirm" != "true" ]]; then
		read -r -p "Type 'FACTORY RESET' to confirm: " response
		if [[ "$response" != "FACTORY RESET" ]]; then
			log_info "Factory reset cancelled"
			return 0
		fi
	fi

	echo ""
	log_info "Stopping services..."
	sudo systemctl stop puppet 2>/dev/null || true
	cd /opt/alm 2>/dev/null && $DOCKER_COMPOSE_CMD down 2>/dev/null || true

	echo ""
	log_info "Removing ALL Docker containers..."
	# shellcheck disable=SC2086 # Word splitting intentional - DOCKER_CMD may be "sudo docker"
	$DOCKER_CMD ps -aq 2>/dev/null | xargs -r $DOCKER_CMD rm -f 2>/dev/null || true

	echo ""
	log_info "Removing ALL Docker images..."
	# shellcheck disable=SC2086 # Word splitting intentional - DOCKER_CMD may be "sudo docker"
	$DOCKER_CMD images -q 2>/dev/null | xargs -r $DOCKER_CMD rmi -f 2>/dev/null || true

	echo ""
	log_info "Removing Docker volumes..."
	# shellcheck disable=SC2086 # Word splitting intentional - DOCKER_CMD may be "sudo docker"
	$DOCKER_CMD volume ls -q 2>/dev/null | xargs -r $DOCKER_CMD volume rm 2>/dev/null || true

	echo ""
	log_info "Clearing Docker temp files and restarting Docker..."
	sudo systemctl stop docker 2>/dev/null || true
	sudo rm -rf /var/lib/docker/tmp/* 2>/dev/null || true
	sudo systemctl start docker 2>/dev/null || true
	sleep 2

	echo ""
	log_info "Ensuring docker-compose-plugin is installed..."
	if ! docker compose version &>/dev/null; then
		sudo apt-get update -qq 2>/dev/null
		sudo apt-get install -y docker-compose-plugin 2>/dev/null || true
	fi

	echo ""
	log_info "Clearing Puppet state..."
	sudo rm -rf /etc/puppetlabs/puppet/ssl
	sudo rm -rf /opt/puppetlabs/puppet/cache
	sudo rm -f /var/lib/puppet-config-done

	echo ""
	log_info "Requesting certificate cleanup on Puppet server..."
	local certname
	certname=$(hostname)
	# Request cert cleanup via SSH (if key-based auth available)
	if ssh -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
		root@puppet.strealer.io \
		"${PUPPETSERVER_BIN} ca clean --certname $certname" 2>/dev/null; then
		log_success "Old certificate cleaned on server"
	else
		log_warning "Could not clean cert remotely (will be handled by watchdog within 2 min)"
	fi

	echo ""
	log_info "Clearing ALM runtime state..."
	sudo rm -rf /var/lib/alm
	sudo rm -f /var/log/alm/*.log 2>/dev/null || true

	echo ""
	log_info "Running Puppet setup script from repository..."
	local setup_url="https://raw.githubusercontent.com/strealer/alm-config/main/system-files/configure_puppet_agent.sh"
	if curl -fsSL "$setup_url" | sudo bash; then
		log_success "Puppet setup completed"
	else
		log_error "Puppet setup script failed"
		return 1
	fi

	echo ""
	log_success "Factory reset complete!"
	echo ""
	echo -e "${CYAN}What's happening now:${NC}"
	echo "  • Puppet agent is running and will configure the device"
	echo "  • Docker images will be pulled (2-4 minutes)"
	echo "  • Containers will be started automatically"
	echo ""
	echo -e "${BLUE}Monitor progress:${NC}"
	echo "  • Run: /usr/local/bin/alm-setup-progress"
	echo "  • Or:  journalctl -u puppet -f"
	echo ""
}

#
# Command: alm puppet-config
# Update puppet.conf from repository
#
cmd_puppet_config() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm puppet-config

Update puppet.conf from the alm-config repository.

This command:
  1. Determines the correct certname from SSL cert or hostname
  2. Downloads the puppet.conf template from GitHub
  3. Substitutes the certname placeholder
  4. Optionally restarts Puppet agent

Use this to fix puppet.conf without doing a full factory-reset.

Requires: sudo privileges

Examples:
  alm puppet-config
EOF
		return 0
	fi

	log_info "Updating puppet.conf from repository..."

	# PRIORITY 1: Extract certname from SSL certificate filename (most authoritative)
	local certname=""
	local ssl_cert_dir="/etc/puppetlabs/puppet/ssl/certs"
	if [[ -d "$ssl_cert_dir" ]]; then
		local node_cert=""
		for cert_file in "$ssl_cert_dir"/*.pem; do
			if [[ -f "$cert_file" ]] && [[ "$(basename "$cert_file")" != "ca.pem" ]]; then
				node_cert="$cert_file"
				break
			fi
		done
		if [[ -n "$node_cert" ]]; then
			certname=$(basename "$node_cert" .pem)
			log_info "Found certname from SSL cert: $certname"
		fi
	fi

	# PRIORITY 2: Use system hostname
	if [[ -z "$certname" ]]; then
		certname=$(hostname)
		log_info "Using system hostname: $certname"
	fi

	# Validate certname format: <env>-<type>-<secret>-<serial>
	if ! echo "$certname" | grep -qE "^(prod|stg|dev)-[a-zA-Z0-9]+-[a-zA-Z0-9]+-[a-zA-Z0-9]+$"; then
		log_error "Certname '$certname' doesn't match required format: <env>-<type>-<secret>-<serial>"
		log_error "Example: prod-rpi4-c7368910b6-14b52e5c"
		log_error "Run configure_puppet_agent.sh to fix hostname, or check /etc/strealer/autosign_secret"
		return 1
	fi

	# Download puppet.conf template and substitute certname
	local config_url="https://raw.githubusercontent.com/strealer/alm-config/main/system-files/puppet.conf"
	sudo mkdir -p /etc/puppetlabs/puppet
	if curl -fsSL "$config_url" | sed "s/%%HOSTNAME%%/$certname/g" | sudo tee /etc/puppetlabs/puppet/puppet.conf >/dev/null; then
		log_success "puppet.conf updated with certname: $certname"
	else
		log_error "Failed to download puppet.conf template"
		return 1
	fi

	echo ""
	read -r -p "Restart Puppet agent now? [y/N]: " response
	if [[ "$response" =~ ^[Yy]$ ]]; then
		log_info "Restarting Puppet agent..."
		sudo systemctl restart puppet
		log_success "Puppet agent restarted"
	else
		log_info "Puppet agent not restarted. Run 'sudo systemctl restart puppet' to apply changes."
	fi
}

#
# Command: alm update
# Update the alm CLI tool from repository
#
cmd_update() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm update

Update the alm CLI tool from the alm-config repository.

This downloads the latest version of the alm script from GitHub
and replaces the current installation.

Requires: sudo privileges

Examples:
  alm update
EOF
		return 0
	fi

	log_info "Updating alm CLI from repository..."

	local alm_url="https://raw.githubusercontent.com/strealer/alm-config/main/system-files/alm"
	local alm_path="/opt/alm/bin/alm"
	local tmp_path="/tmp/alm.new"

	# Download to temp location first
	if ! curl -fsSL -o "$tmp_path" "$alm_url"; then
		log_error "Failed to download alm CLI"
		rm -f "$tmp_path"
		return 1
	fi

	# Verify it's a valid bash script
	if ! head -1 "$tmp_path" | grep -q "^#!/bin/bash"; then
		log_error "Downloaded file doesn't appear to be a valid bash script"
		rm -f "$tmp_path"
		return 1
	fi

	# Install the new version
	sudo mv "$tmp_path" "$alm_path"
	sudo chmod +x "$alm_path"

	log_success "alm CLI updated successfully!"
	log_info "Run 'alm help' to see available commands"
}

#
# Command: alm environment
# Show or change the ALM environment (staging/production)
#
cmd_environment() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm environment [staging|production]

Show or change the ALM environment.

${BLUE}Without arguments:${NC}
  Shows the current environment setting

${BLUE}With argument:${NC}
  Changes the environment to staging or production

${RED}⚠️  WARNING: Changing environment will:${NC}
  1. Update /etc/alm-environment file
  2. Clean Puppet SSL certificates
  3. Regenerate hostname with new prefix (stg-/prod-)
  4. Re-register device with Puppet server
  5. Re-register device with backend API

${BLUE}Environments:${NC}
  ${GREEN}staging${NC}     - Uses TEST content, fapi-test.strealer.io
  ${GREEN}production${NC}  - Uses PRODUCTION+PRELIVE, fapi.strealer.io

Requires: sudo privileges (when changing)

Examples:
  alm environment              # Show current environment
  alm env                      # Short alias
  alm environment staging      # Switch to staging
  alm environment production   # Switch to production
EOF
		return 0
	fi

	local env_file="/etc/alm-environment"
	local current_env=""

	# Detect current environment
	if [[ -n "${ALM_ENVIRONMENT:-}" ]]; then
		current_env="$ALM_ENVIRONMENT"
	elif [[ -f "$env_file" ]]; then
		current_env=$(tr -d '[:space:]' <"$env_file")
	fi

	# Normalize
	case "${current_env,,}" in
	staging | stg) current_env="staging" ;;
	*) current_env="production" ;;
	esac

	# If no argument, just show current environment
	if [[ $# -eq 0 ]]; then
		echo ""
		log_info "Current environment: ${GREEN}${current_env}${NC}"
		echo ""
		if [[ "$current_env" == "staging" ]]; then
			echo "  Hostname prefix: stg-"
			echo "  Content: TEST only"
			echo "  API: fapi-test.strealer.io"
		else
			echo "  Hostname prefix: prod-"
			echo "  Content: PRODUCTION + PRELIVE"
			echo "  API: fapi.strealer.io"
		fi
		echo ""
		echo "Current hostname: $(hostname)"
		echo ""
		echo "To change: alm environment [staging|production]"
		return 0
	fi

	# Validate target environment
	local target_env="$1"
	case "${target_env,,}" in
	staging | stg) target_env="staging" ;;
	production | prod) target_env="production" ;;
	*)
		log_error "Invalid environment: $target_env"
		echo "Valid options: staging, production"
		return 1
		;;
	esac

	# Check if already in target environment
	if [[ "$current_env" == "$target_env" ]]; then
		log_info "Already in ${GREEN}${target_env}${NC} environment"
		return 0
	fi

	# Confirm the change
	echo ""
	log_warning "This will change environment from ${YELLOW}${current_env}${NC} to ${GREEN}${target_env}${NC}"
	echo ""
	echo "This will:"
	echo "  1. Update environment configuration"
	echo "  2. Clean Puppet SSL certificates"
	echo "  3. Change hostname prefix ($(hostname) → new hostname)"
	echo "  4. Re-register with Puppet server"
	echo "  5. Re-register with backend API"
	echo ""
	read -r -p "Are you sure you want to continue? [y/N] " response
	if [[ ! "$response" =~ ^[Yy]$ ]]; then
		log_info "Aborted"
		return 0
	fi

	echo ""
	log_info "Changing environment to ${target_env}..."

	# Write environment file
	echo "$target_env" | sudo tee "$env_file" >/dev/null
	log_success "Updated $env_file"

	# Stop containers first
	log_info "Stopping ALM containers..."
	$DOCKER_COMPOSE_CMD -f /opt/alm/docker-compose.yml down 2>/dev/null || true

	# Clean up Puppet state
	log_info "Cleaning Puppet certificates and configuration..."
	sudo rm -rf /etc/puppetlabs/puppet/ssl
	sudo rm -f /etc/puppetlabs/puppet/puppet.conf
	sudo rm -f /var/lib/puppet-config-done

	# Clean up Docker volumes (registration state)
	log_info "Cleaning registration state..."
	$DOCKER_CMD volume rm alm_config alm_persist 2>/dev/null || true

	# Request cert cleanup on Puppet server
	local old_certname
	old_certname=$(hostname)
	log_info "Requesting certificate cleanup on Puppet server..."
	if ssh -o BatchMode=yes -o ConnectTimeout=5 -o StrictHostKeyChecking=no \
		root@puppet.strealer.io \
		"${PUPPETSERVER_BIN} ca clean --certname $old_certname" 2>/dev/null; then
		log_success "Old certificate cleaned on server"
	else
		log_warning "Could not clean cert remotely (will be handled by watchdog)"
	fi

	# Run Puppet setup with new environment
	echo ""
	log_info "Running Puppet setup with new environment..."
	local setup_url="https://raw.githubusercontent.com/strealer/alm-config/main/system-files/configure_puppet_agent.sh"
	if curl -fsSL "$setup_url" | sudo ALM_ENVIRONMENT="$target_env" bash; then
		log_success "Puppet setup completed with new environment"
	else
		log_error "Puppet setup failed"
		return 1
	fi

	echo ""
	log_success "Environment changed to ${GREEN}${target_env}${NC}"
	echo ""
	echo "New hostname: $(hostname)"
	echo ""
	echo "Next steps:"
	echo "  - Puppet will configure the device (wait ~5 min)"
	echo "  - Init container will re-register with backend"
	echo "  - Check progress: alm logs init"
}

#
# Command: alm help
# Show usage information
#
cmd_help() {
	cat <<EOF
${CYAN}ALM - Autonomous Local Manager CLI${NC}

Device management tool for Strealer edge computing system.

${BLUE}Usage:${NC}
  alm <command> [options]

${BLUE}Commands:${NC}
  ${GREEN}status${NC}         Show device and container status
  ${GREEN}logs${NC}           Follow container logs in real-time
  ${GREEN}pull${NC}           Monitor Docker image pull progress
  ${GREEN}restart${NC}        Restart ALM service
  ${GREEN}reset${NC}          Reset containers and volumes (keeps Docker)
  ${GREEN}factory-reset${NC}  Complete reset to fresh-boot state (removes Docker)
  ${GREEN}puppet-config${NC}  Update puppet.conf from repository
  ${GREEN}update${NC}         Update the alm CLI tool from repository
  ${GREEN}environment${NC}    Show or change environment (staging/production)
  ${GREEN}help${NC}           Show this help message

${BLUE}Examples:${NC}
  alm status            # Check device and container status
  alm logs init         # View init container logs (registration process)
  alm logs main         # View main container logs (application)
  alm pull -f           # Monitor image download progress in real-time
  alm restart           # Restart ALM service
  alm reset             # Reset containers (quick reset)
  alm factory-reset     # Full reset like fresh flash (for testing)
  alm env               # Show current environment
  alm env staging       # Switch to staging environment

${BLUE}Get Help for Specific Commands:${NC}
  alm logs --help
  alm pull --help
  alm restart --help
  alm reset --help
  alm factory-reset --help
  alm puppet-config --help
  alm update --help
  alm environment --help

${BLUE}Automated Registration:${NC}
  • Device registration is FULLY AUTOMATED
  • No user interaction needed - just power on and connect LAN
  • Init container runs automatically and registers with backend
  • Main service starts automatically after registration completes
  • Check registration progress: alm logs init

${BLUE}Troubleshooting:${NC}
  • Check status:       alm status
  • View logs:          alm logs
  • Monitor updates:    alm pull
  • Restart service:    alm restart
  • Restart containers: alm restart
  • Docker status:      sudo systemctl status docker

${BLUE}Service Ports:${NC}
  • 80:   Main application service (after automated registration)

For more information, visit: https://github.com/strealer/alm-config
EOF
}

#
# Command: alm pull
# Monitor Docker image pull progress
#
cmd_pull() {
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cat <<EOF
Usage: alm pull [options]

Monitor Docker image pull progress in real-time.

This command shows the progress of Docker image downloads that happen
automatically via Puppet every 30 minutes. You can see:
  • Real-time download progress with percentages
  • Layer-by-layer extraction status
  • Cached vs new downloads
  • Overall pull completion

Options:
  -f, --follow    Follow log file in real-time (like tail -f)
  -n NUM          Show last NUM lines (default: 50)

Examples:
  alm pull              # Show recent pull activity
  alm pull -f           # Follow pull progress in real-time
  alm pull -n 100       # Show last 100 lines

Log Location:
  /var/log/alm/docker-pull.log

Note: Image pulls happen automatically via Puppet. This command only
monitors the progress - it does not trigger new pulls.
EOF
		return 0
	fi

	local log_file="/var/log/alm/docker-pull.log"
	local follow=false
	local lines=50

	# Parse options
	while [[ $# -gt 0 ]]; do
		case "$1" in
		-f | --follow)
			follow=true
			shift
			;;
		-n | --lines)
			if [[ -n "${2:-}" ]] && [[ "$2" =~ ^[0-9]+$ ]]; then
				lines=$2
				shift 2
			else
				log_error "Option -n requires a numeric argument"
				return 1
			fi
			;;
		*)
			log_error "Unknown option: $1"
			echo "Run 'alm pull --help' for usage information"
			return 1
			;;
		esac
	done

	echo ""
	log_info "Docker Image Pull Progress Monitor"
	echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	echo ""

	# Check if log file exists
	if [[ ! -f "$log_file" ]]; then
		log_warning "Log file not found: $log_file"
		echo ""
		log_info "The log file will be created when Puppet runs the next image pull."
		log_info "Puppet runs automatically every 30 minutes to check for updates."
		echo ""
		log_info "You can also check Puppet logs for pull activity:"
		echo "  sudo journalctl -u puppet -f | grep docker-pull"
		return 0
	fi

	if [[ "$follow" == true ]]; then
		log_info "Following pull progress (press Ctrl+C to stop)..."
		echo ""
		tail -f "$log_file"
	else
		log_info "Showing last $lines lines from pull log..."
		echo ""
		tail -n "$lines" "$log_file"
		echo ""
		log_info "Use 'alm pull -f' to follow real-time progress"
	fi
}

#
# Main command dispatcher
#
main() {
	# Check if no arguments provided
	if [[ $# -eq 0 ]]; then
		cmd_help
		return 0
	fi

	local command="$1"
	shift

	case "$command" in
	status)
		cmd_status "$@"
		;;
	logs)
		cmd_logs "$@"
		;;
	pull)
		cmd_pull "$@"
		;;
	restart)
		cmd_restart "$@"
		;;
	reset)
		cmd_reset "$@"
		;;
	factory-reset)
		cmd_factory_reset "$@"
		;;
	puppet-config)
		cmd_puppet_config "$@"
		;;
	update)
		cmd_update "$@"
		;;
	environment | env)
		cmd_environment "$@"
		;;
	help | --help | -h)
		cmd_help
		;;
	*)
		log_error "Unknown command: $command"
		echo ""
		echo "Run 'alm help' to see available commands"
		return 1
		;;
	esac
}

# Execute main function if script is run directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
	main "$@"
fi
