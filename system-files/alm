#!/bin/bash
#
# ALM - Autonomous Local Manager CLI
# Device management tool for Strealer edge computing system
#
# Usage: alm <command> [options]
# Commands: status, logs, restart, reset, help
#
# NOTE: Registration is fully automated - no user interaction needed
#

set -euo pipefail

# Colors for output (use $'...' syntax for escape sequence interpretation)
readonly RED=$'\033[0;31m'
readonly GREEN=$'\033[0;32m'
readonly YELLOW=$'\033[1;33m'
readonly BLUE=$'\033[0;34m'
readonly CYAN=$'\033[0;36m'
readonly NC=$'\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${BLUE}ℹ${NC} $*"
}

log_success() {
    echo -e "${GREEN}✅${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $*"
}

log_error() {
    echo -e "${RED}❌${NC} $*" >&2
}

# Check if container is running via HTTP health check (no docker access needed)
is_container_healthy() {
    local port=$1
    curl -sf --max-time 1 "http://localhost:${port}" >/dev/null 2>&1
}

# Get device IP address
get_device_ip() {
    ip route get 1.1.1.1 2>/dev/null | grep -oP 'src \K[0-9.]+' || echo "unknown"
}

# Get architecture
get_architecture() {
    local arch
    arch=$(uname -m)
    case "$arch" in
        aarch64|arm64) echo "ARM64" ;;
        x86_64|amd64) echo "AMD64" ;;
        *) echo "$arch" ;;
    esac
}

# Detect container suffix based on architecture
get_container_suffix() {
    local arch
    arch=$(uname -m)
    if [[ "$arch" == "aarch64" ]] || [[ "$arch" == "arm64" ]]; then
        echo "arm64"
    else
        echo "amd64"
    fi
}

# Get main container image checksum (SHA256)
get_image_checksum() {
    local main_container="alm"

    # Get image ID from running/stopped container
    local image_id
    image_id=$(sudo docker ps -a --filter "name=^${main_container}$" --format "{{.Image}}" 2>/dev/null)

    if [[ -z "$image_id" ]]; then
        echo "unknown"
        return 1
    fi

    # Get full image digest
    local digest
    digest=$(sudo docker inspect --format='{{index .RepoDigests 0}}' "$image_id" 2>/dev/null | grep -oP 'sha256:\K[a-f0-9]{64}' || echo "")

    if [[ -n "$digest" ]]; then
        # Return first 12 characters of SHA256
        echo "${digest:0:12}"
    else
        # Fallback to short image ID
        sudo docker inspect --format='{{.ID}}' "$image_id" 2>/dev/null | grep -oP 'sha256:\K[a-f0-9]{12}' || echo "unknown"
    fi
}

#
# Command: alm status
# Show device and container status
#
cmd_status() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
Usage: alm status

Display device information and container status.

Shows:
  • Current container image checksum
  • Device IP address and hostname
  • System architecture (ARM64/AMD64)
  • Docker service status
  • Init container status
  • Main container status
  • Service accessibility

Examples:
  alm status
EOF
        return 0
    fi

    local ip
    local hostname
    local arch
    local checksum

    ip=$(get_device_ip)
    hostname=$(hostname)
    arch=$(get_architecture)
    checksum=$(get_image_checksum)

    echo -e "${CYAN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}  ${GREEN}ALM Device Status${NC}                                        ${CYAN}║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""

    echo -e "${BLUE}Image Checksum:${NC}"
    echo "  SHA256: $checksum"
    echo ""

    echo -e "${BLUE}Device Information:${NC}"
    echo "  IP Address:   $ip"
    echo "  Hostname:     $hostname"
    echo "  Architecture: $arch"
    echo ""

    echo -e "${BLUE}Docker Service:${NC}"
    if systemctl is-active --quiet docker 2>/dev/null; then
        log_success "Docker is running"
    else
        log_error "Docker is not running"
        echo "  Start with: sudo systemctl start docker"
        return 1
    fi
    echo ""

    echo -e "${BLUE}Container Status:${NC}"

    local init_container="alm_init"
    local main_container="alm"

    # Check init container (should exit after successful registration)
    if sudo docker ps -a --format "{{.Names}}" | grep -Fxq "$init_container"; then
        init_status=$(sudo docker ps -a --filter "name=^${init_container}$" --format "{{.Status}}")
        if echo "$init_status" | head -n1 | grep -q "Exited (0)"; then
            log_success "Init container: Completed successfully"
            echo "    Registration complete, device initialized"
        else
            log_warning "Init container: $init_status"
            echo "    Device may still be registering..."
        fi
    else
        log_info "Init container: Not found (may have been cleaned up)"
    fi

    # Check main container (via HTTP on port 80)
    if sudo docker ps -a --format "{{.Names}}" | grep -Fxq "$main_container"; then
        if is_container_healthy 80; then
            log_success "Main container: Running"
            echo "    Port 80: Application service"
            echo ""
            echo -e "${GREEN}Service URL:${NC} http://$ip:80"
        else
            log_warning "Main container: Container exists but HTTP check failed"
            echo "    Device may still be initializing"
            echo "    Check logs: alm logs"
        fi
    else
        log_warning "Main container: Not found"
        echo "    Start containers: alm restart"
    fi

    echo ""
    echo -e "${BLUE}Telemetry Worker:${NC}"
    telemetry_status=$(sudo docker ps -a --filter "name=^alm_telemetry$" --format "{{.Status}}")
    if [[ -n "$telemetry_status" ]]; then
        if echo "$telemetry_status" | grep -qi "Up"; then
            log_success "Telemetry container: Running"
            echo "    Sends device info every 5 minutes"
        else
            log_warning "Telemetry container: $telemetry_status"
            echo "    Check logs: alm logs telemetry"
        fi
    else
        log_warning "Telemetry container: Not found"
        echo "    Start containers: alm restart"
    fi

    echo ""
}

#
# Command: alm logs
# Follow container logs
#
cmd_logs() {
    local container_type="main"
    local follow=true
    local tail_lines=50

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            init|main|telemetry)
                container_type="$1"
                shift
                ;;
            --no-follow|-n)
                follow=false
                shift
                ;;
            --tail)
                tail_lines="$2"
                shift 2
                ;;
            --help|-h)
                cat <<EOF
Usage: alm logs [CONTAINER] [OPTIONS]

Follow container logs in real-time.

Arguments:
  CONTAINER    Container to show logs for: init, main, telemetry (default: main)

Options:
  --no-follow  Show logs without following (exit after display)
  --tail N     Number of lines to show (default: 50)
  --help       Show this help message

Examples:
  alm logs              # Follow main container logs
  alm logs init         # Follow init container logs
  alm logs --tail 100   # Show last 100 lines
  alm logs init -n      # Show init logs without following
EOF
                return 0
                ;;
            *)
                log_error "Unknown option: $1"
                echo "Use 'alm logs --help' for usage information"
                return 1
                ;;
        esac
    done

    local container_name
    case "$container_type" in
        init)
            container_name="alm_init"
            ;;
        telemetry)
            container_name="alm_telemetry"
            ;;
        *)
            container_name="alm"
            ;;
    esac

    # Show logs using sudo docker (handle gracefully if fails)
    log_info "Showing logs for: $container_name"
    echo ""

    if [[ "$follow" == true ]]; then
        sudo docker logs -f --tail "$tail_lines" "$container_name" 2>/dev/null || {
            log_error "Could not access container logs (requires sudo/docker access)"
            return 1
        }
    else
        sudo docker logs --tail "$tail_lines" "$container_name" 2>/dev/null || {
            log_error "Could not access container logs (requires sudo/docker access)"
            return 1
        }
    fi
}

#
# Command: alm restart
# Restart ALM containers
#
cmd_restart() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
Usage: alm restart

Restart the ALM containers using Docker Compose.

This will:
  1. Stop all running containers
  2. Start containers based on architecture
  3. Show updated status

Requires: sudo privileges

Examples:
  alm restart
EOF
        return 0
    fi

    log_info "Restarting ALM containers..."
    echo ""

    cd /opt/alm 2>/dev/null || {
        log_error "ALM directory not found at /opt/alm"
        return 1
    }

    log_info "Stopping containers..."
    sudo docker compose down 2>/dev/null || true

    log_info "Starting containers..."
    # Uses unified service names (multi-arch auto-detection by Docker)
    sudo docker compose up -d --remove-orphans alm_init alm alm_telemetry

    log_success "Containers restarted successfully"
    echo ""

    log_info "Waiting for containers to start..."
    sleep 5

    echo ""
    cmd_status
}

#
# Command: alm reset
# Reset device to allow fresh registration
#
cmd_reset() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
Usage: alm reset

Reset the ALM device to start fresh registration.

${RED}WARNING: This will:${NC}
  1. Stop and remove all containers
  2. Delete all configuration and registration data
  3. Remove Docker volumes
  4. Restart service for fresh automated setup

Use this when:
  • Registration is stuck or incomplete
  • Need to re-register the device
  • Want to start configuration from scratch

Requires: sudo privileges

Examples:
  alm reset
EOF
        return 0
    fi

    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║${NC}  ${YELLOW}WARNING: This will delete all ALM data and config${NC}         ${RED}║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "This will:"
    echo "  • Stop all running containers"
    echo "  • Remove all containers and volumes"
    echo "  • Delete registration and configuration data"
    echo "  • Reset device to fresh state"
    echo ""

    read -r -p "Are you sure you want to reset? [y/N]: " response

    if [[ ! "$response" =~ ^[Yy]$ ]]; then
        log_info "Reset cancelled"
        return 0
    fi

    echo ""
    log_info "Stopping ALM service..."
    sudo systemctl stop strealer-container.service 2>/dev/null || true

    echo ""
    log_info "Removing containers..."

    # Stop and remove containers (unified names - no architecture suffix)
    sudo docker stop "alm_init" 2>/dev/null || true
    sudo docker stop "alm" 2>/dev/null || true
    sudo docker stop "alm_telemetry" 2>/dev/null || true
    sudo docker rm "alm_init" 2>/dev/null || true
    sudo docker rm "alm" 2>/dev/null || true
    sudo docker rm "alm_telemetry" 2>/dev/null || true

    echo ""
    log_info "Removing Docker volumes..."

    # Remove volumes
    cd /opt/alm 2>/dev/null || true
    sudo docker compose down -v 2>/dev/null || true

    # Clean up any orphaned volumes
    sudo docker volume ls -q | grep -E "alm_config|alm_persist" | xargs -r sudo docker volume rm 2>/dev/null || true

    echo ""
    log_success "Reset complete!"
    echo ""
    log_info "Restarting service for automated re-registration..."

    sudo systemctl start strealer-container.service

    echo ""
    log_success "Device is re-registering automatically"
    log_info "Registration happens in background (no user action needed)"
    log_info "Check progress with: alm logs init"
    echo ""
}

#
# Command: alm factory-reset
# Complete reset to simulate fresh flash (removes Docker too)
#
cmd_factory_reset() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
Usage: alm factory-reset

Reset device to a FRESH-BOOT state (like a newly flashed device).

${RED}⚠️  DANGER ZONE - This goes beyond 'alm reset':${NC}
  1. Removes ALL Docker containers, images, and volumes
  2. Uninstalls Docker completely (Puppet will reinstall)
  3. Clears Puppet certificate and agent state
  4. Deletes ALL ALM runtime state and config
  5. Re-enables first-boot configure_puppet_agent.service

${BLUE}What is KEPT (pi-gen installed):${NC}
  • User accounts (almadmin, almuser, root)
  • SSH authorized_keys
  • ALM CLI tool, setup-progress script
  • Basic directory structure (/opt/alm)

After this, the next SSH login will:
  • Show "Installing Docker..." progress
  • Run configure_puppet_agent.service
  • Re-run full Puppet setup from scratch
  • Pull fresh images and start containers

Use this to:
  • Test the full first-boot experience
  • Simulate a completely fresh device
  • Debug initial setup issues

Requires: sudo privileges

Examples:
  alm factory-reset
EOF
        return 0
    fi

    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║${NC}  ${RED}⚠️  DANGER: FACTORY RESET - SIMULATES FRESH FLASH${NC}        ${RED}║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "This will reset to FRESH-BOOT state by removing:"
    echo "  • ALL Docker containers, images, and volumes"
    echo "  • Docker installation (will be reinstalled by Puppet)"
    echo "  • Puppet certificate and agent state"
    echo "  • ALL ALM runtime state and config"
    echo ""
    echo -e "${BLUE}Keeping (pi-gen installed):${NC}"
    echo "  • User accounts and SSH keys"
    echo "  • ALM CLI and setup-progress script"
    echo ""
    echo -e "${YELLOW}Next login will show full first-boot setup progress.${NC}"
    echo ""

    read -r -p "Type 'FACTORY RESET' to confirm: " response

    if [[ "$response" != "FACTORY RESET" ]]; then
        log_info "Factory reset cancelled"
        return 0
    fi

    echo ""
    log_info "Stopping services..."
    sudo systemctl stop strealer-container.service 2>/dev/null || true
    sudo systemctl stop docker 2>/dev/null || true
    sudo systemctl stop puppet 2>/dev/null || true

    echo ""
    log_info "Removing ALL Docker containers..."
    sudo docker rm -f $(sudo docker ps -aq) 2>/dev/null || true

    echo ""
    log_info "Removing ALL Docker images..."
    sudo docker rmi -f $(sudo docker images -q) 2>/dev/null || true

    echo ""
    log_info "Removing Docker volumes..."
    sudo docker volume rm $(sudo docker volume ls -q) 2>/dev/null || true

    echo ""
    log_info "Uninstalling Docker..."
    sudo apt-get purge -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-buildx-plugin 2>/dev/null || true
    sudo rm -rf /var/lib/docker /etc/docker /var/lib/containerd

    echo ""
    log_info "Clearing Puppet state..."
    sudo rm -rf /etc/puppetlabs/puppet/ssl
    sudo rm -f /etc/puppetlabs/puppet/puppet.conf
    sudo rm -rf /opt/puppetlabs/puppet/cache
    sudo rm -f /var/lib/puppet-config-done  # Allow configure_puppet_agent.sh to re-run

    echo ""
    log_info "Clearing ALM runtime state..."
    sudo rm -rf /var/lib/alm
    sudo rm -f /var/log/alm/*.log 2>/dev/null || true

    echo ""
    log_info "Re-enabling first-boot services..."
    sudo systemctl enable configure_puppet_agent.service 2>/dev/null || true

    echo ""
    log_success "Factory reset complete!"
    echo ""
    echo -e "${CYAN}Next steps:${NC}"
    echo "  1. Log out and log back in as root"
    echo "  2. The setup progress screen will appear"
    echo "  3. configure_puppet_agent.service will run"
    echo "  4. Puppet will install Docker and configure everything"
    echo ""
    log_info "Run: exit"
    echo ""
}

#
# Command: alm help
# Show usage information
#
cmd_help() {
    cat <<EOF
${CYAN}ALM - Autonomous Local Manager CLI${NC}

Device management tool for Strealer edge computing system.

${BLUE}Usage:${NC}
  alm <command> [options]

${BLUE}Commands:${NC}
  ${GREEN}status${NC}         Show device and container status
  ${GREEN}logs${NC}           Follow container logs in real-time
  ${GREEN}pull${NC}           Monitor Docker image pull progress
  ${GREEN}restart${NC}        Restart ALM service
  ${GREEN}reset${NC}          Reset containers and volumes (keeps Docker)
  ${GREEN}factory-reset${NC}  Complete reset to fresh-boot state (removes Docker)
  ${GREEN}help${NC}           Show this help message

${BLUE}Examples:${NC}
  alm status            # Check device and container status
  alm logs init         # View init container logs (registration process)
  alm logs main         # View main container logs (application)
  alm pull -f           # Monitor image download progress in real-time
  alm restart           # Restart ALM service
  alm reset             # Reset containers (quick reset)
  alm factory-reset     # Full reset like fresh flash (for testing)

${BLUE}Get Help for Specific Commands:${NC}
  alm logs --help
  alm pull --help
  alm restart --help
  alm reset --help
  alm factory-reset --help

${BLUE}Automated Registration:${NC}
  • Device registration is FULLY AUTOMATED
  • No user interaction needed - just power on and connect LAN
  • Init container runs automatically and registers with backend
  • Main service starts automatically after registration completes
  • Check registration progress: alm logs init

${BLUE}Troubleshooting:${NC}
  • Check status:       alm status
  • View logs:          alm logs
  • Monitor updates:    alm pull
  • Restart service:    alm restart
  • Restart containers: alm restart
  • Docker status:      sudo systemctl status docker

${BLUE}Service Ports:${NC}
  • 80:   Main application service (after automated registration)

For more information, visit: https://github.com/strealer/alm-config
EOF
}

#
# Command: alm pull
# Monitor Docker image pull progress
#
cmd_pull() {
    if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
        cat <<EOF
Usage: alm pull [options]

Monitor Docker image pull progress in real-time.

This command shows the progress of Docker image downloads that happen
automatically via Puppet every 30 minutes. You can see:
  • Real-time download progress with percentages
  • Layer-by-layer extraction status
  • Cached vs new downloads
  • Overall pull completion

Options:
  -f, --follow    Follow log file in real-time (like tail -f)
  -n NUM          Show last NUM lines (default: 50)

Examples:
  alm pull              # Show recent pull activity
  alm pull -f           # Follow pull progress in real-time
  alm pull -n 100       # Show last 100 lines

Log Location:
  /var/log/alm/docker-pull.log

Note: Image pulls happen automatically via Puppet. This command only
monitors the progress - it does not trigger new pulls.
EOF
        return 0
    fi

    local log_file="/var/log/alm/docker-pull.log"
    local follow=false
    local lines=50

    # Parse options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--follow)
                follow=true
                shift
                ;;
            -n|--lines)
                if [[ -n "${2:-}" ]] && [[ "$2" =~ ^[0-9]+$ ]]; then
                    lines=$2
                    shift 2
                else
                    log_error "Option -n requires a numeric argument"
                    return 1
                fi
                ;;
            *)
                log_error "Unknown option: $1"
                echo "Run 'alm pull --help' for usage information"
                return 1
                ;;
        esac
    done

    echo ""
    log_info "Docker Image Pull Progress Monitor"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # Check if log file exists
    if [[ ! -f "$log_file" ]]; then
        log_warning "Log file not found: $log_file"
        echo ""
        log_info "The log file will be created when Puppet runs the next image pull."
        log_info "Puppet runs automatically every 30 minutes to check for updates."
        echo ""
        log_info "You can also check Puppet logs for pull activity:"
        echo "  sudo journalctl -u puppet -f | grep docker-pull"
        return 0
    fi

    if [[ "$follow" == true ]]; then
        log_info "Following pull progress (press Ctrl+C to stop)..."
        echo ""
        tail -f "$log_file"
    else
        log_info "Showing last $lines lines from pull log..."
        echo ""
        tail -n "$lines" "$log_file"
        echo ""
        log_info "Use 'alm pull -f' to follow real-time progress"
    fi
}

#
# Main command dispatcher
#
main() {
    # Check if no arguments provided
    if [[ $# -eq 0 ]]; then
        cmd_help
        return 0
    fi

    local command="$1"
    shift

    case "$command" in
        status)
            cmd_status "$@"
            ;;
        logs)
            cmd_logs "$@"
            ;;
        pull)
            cmd_pull "$@"
            ;;
        restart)
            cmd_restart "$@"
            ;;
        reset)
            cmd_reset "$@"
            ;;
        factory-reset)
            cmd_factory_reset "$@"
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            log_error "Unknown command: $command"
            echo ""
            echo "Run 'alm help' to see available commands"
            return 1
            ;;
    esac
}

# Execute main function if script is run directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
