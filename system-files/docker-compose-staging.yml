# ============================================================================
# Strealer ALM Multi-Container Stack - STAGING ENVIRONMENT
# ============================================================================
# STAGING CONFIGURATION:
# - Registration API: public-staging.strealer.io
# - Management API: fapi-test.strealer.io
# - Content: TEST environment ONLY (no PRODUCTION or PRELIVE)
# - Database: Separate staging database
#
# USE FOR: Testing ALM infrastructure changes before production deployment
# ============================================================================
services:
  # ========================================================================
  # PHASE 1: AUTOMATED DEVICE REGISTRATION AND INITIALIZATION
  # ========================================================================

  # Multi-Arch Init Service (auto-detects ARM64/AMD64)
  # FULLY AUTOMATED - No user interaction required
  alm_init:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:${ALM_INIT_TAG:-latest}
    container_name: alm_init
    network_mode: host # Use host network to access Host OS local IP
    # No ports exposed - fully automated registration via API
    volumes:
      # Shared configuration volumes (init generates, main app consumes)
      - alm_config:/opt/alm/config # Generated configurations
      - alm_persist:/opt/alm/persist # Persistent device data
      # Host system access for device detection
      - /proc/cpuinfo:/proc/cpuinfo:ro # For serial number detection
      - /etc/hostname:/etc/hostname:ro # For hostname detection
    environment:
      # STAGING ENVIRONMENT CONFIGURATION
      - ALM_ENVIRONMENT=staging
      - MANAGEMENT_API_URL=https://fapi-test.strealer.io
      - REGISTRATION_API_URL=http://public-staging.strealer.io/register/alm
      - X_API_KEY=cwSL8sAAiT7QWyvMulL4f6Mtmet7klzV
    restart: "no" # Run once until INIT_DONE=1, then exit

  # Dedicated telemetry worker that keeps cron_5m.sh running every five minutes.
  alm_telemetry:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-telemetry/alm-telemetry:${ALM_TELEMETRY_TAG:-latest}
    container_name: alm_telemetry
    network_mode: host
    volumes:
      - alm_config:/opt/alm/config
      - alm_persist:/opt/alm/persist
      - /proc/cpuinfo:/proc/cpuinfo:ro
      - /etc/hostname:/etc/hostname:ro
      - /etc/os-release:/host/etc/os-release:ro
    environment:
      - ALM_ENVIRONMENT=staging
    restart: unless-stopped # Cron runner should always stay online

  # ========================================================================
  # PHASE 2: MAIN ALM APPLICATION CONTAINERS
  # ========================================================================

  # Multi-Arch Main Service (auto-detects ARM64/AMD64)
  alm:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:${ALM_APP_TAG:-latest}
    container_name: alm
    ports:
      - "80:80" # Main HTTP traffic for content delivery
    volumes:
      # Configuration files generated by init container
      - alm_config:/opt/alm/config:ro
      # Shared logs volume
      - /var/log/alm/nginx:/var/log/nginx
    environment:
      - HOST_IP_FILE=/host_ip
      - INIT_REQUIRED=true # Wait for init completion before starting
      # STAGING: Only TEST content routes will be configured
      - ALM_ENVIRONMENT=staging
    depends_on:
      alm_init:
        condition: service_completed_successfully # Wait for init to complete
    restart: unless-stopped # Auto-restart main service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ============================================================================
# SHARED VOLUMES FOR CONFIGURATION MANAGEMENT
# ============================================================================
volumes:
  alm_config:
  alm_persist:

# ============================================================================
# STAGING ENVIRONMENT NOTES
# ============================================================================
# - Devices registered here use a SEPARATE database from production
# - Only TEST content routes are available (/media-test, /player-test, /renderer-test)
# - Cannot switch to PRODUCTION/PRELIVE - different database
# - Use hostname pattern: stg-rpi4-<secret>-<serial>-<epoch> or stg-amd-<secret>-<name>-<epoch>
# ============================================================================
