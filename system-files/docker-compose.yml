# ============================================================================
# Strealer ALM Multi-Container Stack (Zeroâ€‘Touch Registration)
# ----------------------------------------------------------------------------
# - **Init phase** (`alm_init_*`): BASH-only bootstrap that registers the device,
#   pulls configuration from fapi-staging, writes shared volumes, then exits.
# - **Main phase** (`alm_*`): ALM Java application with nginx cache exposed on
#   port 80. Services wait on init completion via depends_on conditions.
# - **Telemetry phase** (`alm_telemetry`): Cron sidecar that runs the legacy
#   `cron_5m.sh` workflow every five minutes using the same volumes.
# - **Images**: Multi-arch images are pulled from
#   `europe-west1-docker.pkg.dev/...`. Puppet performs the `docker login`
#   before each pull on real devices. Override tags via `ALM_*_TAG` environment
#   pinning specific versions.
# - **Volumes**: `alm_config` and `alm_persist` are Docker named volumes so no
#   host bind mounts are required.
# - **Networking**: Init containers use `network_mode: host` strictly to read
#   hardware info from the host OS; they do **not** expose HTTP ports anymore.
# ============================================================================
services:
  # ========================================================================
  # PHASE 1: AUTOMATED DEVICE REGISTRATION AND INITIALIZATION
  # ========================================================================

  # Multi-Arch Init Service (auto-detects ARM64/AMD64)
  # FULLY AUTOMATED - No user interaction required
  alm_init:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:${ALM_INIT_TAG:-latest}
    container_name: alm_init
    network_mode: host # Use host network to access Host OS local IP
    # No ports exposed - fully automated registration via API
    volumes:
      # Shared configuration volumes (init generates, main app consumes)
      - alm_config:/opt/alm/config # Generated configurations
      - alm_persist:/opt/alm/persist # Persistent device data
      # Host system access for device detection
      - /proc/cpuinfo:/proc/cpuinfo:ro # For serial number detection
      - /etc/hostname:/etc/hostname:ro # For hostname detection
    environment:
      - MANAGEMENT_API_URL=https://fapi-staging.strealer.io
      - REGISTRATION_API_URL=http://public-staging.strealer.io/register/alm
      - X_API_KEY=cwSL8sAAiT7QWyvMulL4f6Mtmet7klzV
    restart: "no" # Run once until INIT_DONE=1, then exit
    # No healthcheck - init container should exit cleanly after completing registration
  # Dedicated telemetry worker that keeps cron_5m.sh running every five minutes.
  # Shares the same configuration and persistence volumes so it can reuse device
  # credentials and INIT status generated by the init container.
  alm_telemetry:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-telemetry/alm-telemetry:${ALM_TELEMETRY_TAG:-latest}
    container_name: alm_telemetry
    network_mode: host
    volumes:
      - alm_config:/opt/alm/config
      - alm_persist:/opt/alm/persist
      - /proc/cpuinfo:/proc/cpuinfo:ro
      - /etc/hostname:/etc/hostname:ro
      - /etc/os-release:/host/etc/os-release:ro
    restart: unless-stopped # Cron runner should always stay online
  # ========================================================================
  # OBSERVABILITY: VECTOR LOG COLLECTOR
  # ========================================================================
  
  # Vector log collector - ships logs to central Loki instance
  # Collects nginx logs, docker container logs, and system logs
  # Vector service removed - now running as native systemd service
  # alm_vector:
  #   image: timberio/vector:0.34.1-alpine
  #   container_name: alm_vector
  #   network_mode: host
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - /opt/alm/config/vector.yaml:/etc/vector/vector.yaml:ro
  #     - alm_logs:/var/log/alm:ro
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/host/root:ro
  #   environment:
  #     - PROMETHEUS_ENDPOINT=http://104.155.91.159:9090/api/v1/write
  #     - LOKI_ENDPOINT=http://104.155.91.159:3100
  #     - VECTOR_CONFIG=/etc/vector/vector.yaml
  #   restart: unless-stopped
  #   depends_on:
  #     - alm_app

  # ========================================================================
  # PHASE 2: MAIN ALM APPLICATION CONTAINERS
  # ========================================================================

  # Multi-Arch Main Service (auto-detects ARM64/AMD64)
  alm:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:${ALM_APP_TAG:-latest}
    container_name: alm
    ports:
      - "80:80" # Main HTTP traffic for content delivery
    volumes:
      # Configuration files generated by init container
      - alm_config:/opt/alm/config:ro
      # Shared logs volume
      - /var/log/alm/nginx:/var/log/nginx
    environment:
      - HOST_IP_FILE=/host_ip
      - INIT_REQUIRED=true # Wait for init completion before starting
    depends_on:
      alm_init:
        condition: service_completed_successfully # Wait for init to complete
    restart: unless-stopped # Auto-restart main service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
# ============================================================================
# SHARED VOLUMES FOR CONFIGURATION MANAGEMENT
# ============================================================================
volumes:
  # Main configuration volume (shared between init and main containers)
  # Docker-managed named volume - no host directories needed!
  alm_config:
  # Persistent data volume for device-specific information
  # Docker-managed named volume - no host directories needed!
  alm_persist:


# ============================================================================
# DEPLOYMENT NOTES - ZERO HOST SETUP REQUIRED!
# ============================================================================
#
# ZERO-SETUP DEPLOYMENT:
# 1. Copy docker-compose.yml to any directory (e.g., /opt/alm)
# 2. Run: `docker compose up -d` - services start in dependency order:
#    - alm_init runs first, populates shared volumes, then exits
#    - alm (main app) starts after init completes
#    - alm_telemetry starts for cron-based reporting
#
# MULTI-ARCH DEPLOYMENT (AUTOMATIC):
# The docker images are multi-arch manifests. Docker automatically pulls
# the correct architecture (ARM64 or AMD64) based on the host platform.
# No architecture-specific configuration needed!
#
# SERVICE NAMES (Unified - same on all architectures):
# - alm_init: Registration and config generation
# - alm: Main application (Java + nginx)
# - alm_telemetry: Cron-based metrics reporting
#
# CONFIGURATION FLOW:
# 1. Init writes configs/keys into `alm_config` + `alm_persist`
# 2. Main copies configs into /etc and runs ALM Java process
# 3. Telemetry container reuses the same volumes for cron-based reporting
#
# NETWORK NOTES:
# - Init containers rely on host network only for device introspection and API
#   calls; no HTTP ports are exposed during registration.
# - Main containers expose port 80 for cached content.
#
# REGISTRY ACCESS:
# - Ensure the Puppet-managed `docker login` has run (or manually source
#   `/opt/alm/config/gcp-registry-token`) before calling `docker compose pull`
#   on production devices so Artifact Registry pulls work.
# ============================================================================
