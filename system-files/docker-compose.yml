# ============================================================================
# Strealer ALM Multi-Container Docker Compose Configuration
# ============================================================================
#
# WHAT THIS FILE DEFINES:
# - **Multi-Phase Container Orchestration** - Init containers run first, then main app
# - **Device Registration System** - Web-based registration replacing SSH flow
# - **Multi-Architecture Support** - Separate containers for ARM64 and AMD64 systems
# - **Configuration Generation** - Init containers generate configs for main app
# - **Network Discovery** - mDNS and multi-method device access
# - **Port Management** - Init on 8080, Main app on 80 (no conflicts)
#
# CONTAINER LIFECYCLE:
# 1. **Init Phase**: alm_init_* containers start first
#    - Provide web registration interface on port 8080
#    - Generate device configurations
#    - Set INIT_DONE=1 and exit successfully
# 2. **Main Phase**: alm_* containers start after init completion
#    - Run main ALM application with Java + nginx
#    - Serve content on port 80
#    - Use configurations generated by init containers
#
# DEPLOYMENT STRATEGY:
# - **Architecture Detection** - strealer-container.service selects appropriate services
# - **Dependency Management** - Main app waits for init completion
# - **Configuration Sharing** - Shared volumes between init and main containers
# - **Health Monitoring** - Both phases monitored by systemd service
#
# USAGE:
# - **Development**: docker compose up (starts init containers first)
# - **Production**: Managed by strealer-container.service (deployed via Puppet)
# ============================================================================
services:
  # ========================================================================
  # PHASE 1: AUTOMATED DEVICE REGISTRATION AND INITIALIZATION
  # ========================================================================

  # ARM64 Init Service for Raspberry Pi devices
  # FULLY AUTOMATED - No user interaction required
  alm_init_arm64:
    build:
      context: alm-init
      platforms:
        - linux/arm64
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:${ALM_INIT_ARM64_TAG:-arm64-latest}
    container_name: alm_init_arm64
    network_mode: host # Use host network to access Host OS local IP
    # No ports exposed - fully automated registration via API
    volumes:
      # Shared configuration volumes (init generates, main app consumes)
      - alm_config:/opt/alm/config # Generated configurations
      - alm_persist:/opt/alm/persist # Persistent device data
      # Host system access for device detection
      - /proc/cpuinfo:/proc/cpuinfo:ro # For serial number detection
      - /etc/hostname:/etc/hostname:ro # For hostname detection
    environment:
      - DEVICE_ARCH=arm64
      - MANAGEMENT_API_URL=https://fapi-staging.strealer.io
      - REGISTRATION_API_URL=http://public-staging.strealer.io/register/alm
      - X_API_KEY=cwSL8sAAiT7QWyvMulL4f6Mtmet7klzV
    restart: "no" # Run once until INIT_DONE=1, then exit
    # No healthcheck - init container should exit cleanly after completing registration
  # AMD64 Init Service for x86_64 servers
  # FULLY AUTOMATED - No user interaction required
  alm_init_amd64:
    build:
      context: alm-init
      platforms:
        - linux/amd64
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-init/alm-init:${ALM_INIT_AMD64_TAG:-amd64-latest}
    container_name: alm_init_amd64
    network_mode: host # Use host network to access Host OS local IP
    # No ports exposed - fully automated registration via API
    volumes:
      # Shared configuration volumes
      - alm_config:/opt/alm/config
      - alm_persist:/opt/alm/persist
      # Host system access for device detection
      - /proc/cpuinfo:/proc/cpuinfo:ro
      - /etc/hostname:/etc/hostname:ro
    environment:
      - DEVICE_ARCH=amd64
      - MANAGEMENT_API_URL=https://fapi-staging.strealer.io
      - REGISTRATION_API_URL=http://public-staging.strealer.io/register/alm
      - X_API_KEY=cwSL8sAAiT7QWyvMulL4f6Mtmet7klzV
    restart: "no" # Run once until INIT_DONE=1, then exit
    # No healthcheck - init container should exit cleanly after completing registration
  # Dedicated telemetry worker that keeps cron_5m.sh running every five minutes.
  # Shares the same configuration and persistence volumes so it can reuse device
  # credentials and INIT status generated by the init container.
  alm_telemetry:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-telemetry/alm-telemetry:${ALM_TELEMETRY_TAG:-latest}
    container_name: alm_telemetry
    network_mode: host
    volumes:
      - alm_config:/opt/alm/config
      - alm_persist:/opt/alm/persist
      - /proc/cpuinfo:/proc/cpuinfo:ro
      - /etc/hostname:/etc/hostname:ro
      - /etc/os-release:/host/etc/os-release:ro
    restart: unless-stopped # Cron runner should always stay online
  # ========================================================================
  # PHASE 2: MAIN ALM APPLICATION CONTAINERS
  # ========================================================================

  # ARM64 Main Service for Raspberry Pi devices (starts after init completion)
  alm_arm64:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:${ALM_APP_ARM64_TAG:-arm64-latest}
    container_name: alm_arm64
    ports:
      - "80:80" # Main HTTP traffic for content delivery
    volumes:
      # Configuration files generated by init container
      - alm_config:/opt/alm/config:ro # Read-only access to generated configs
    environment:
      - HOST_IP_FILE=/host_ip
      - INIT_REQUIRED=true # Wait for init completion before starting
    depends_on:
      alm_init_arm64:
        condition: service_completed_successfully # Wait for init to complete
    restart: unless-stopped # Auto-restart main service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
  # AMD64 Main Service for x86_64 servers (starts after init completion)
  alm_amd64:
    image: europe-west1-docker.pkg.dev/effective-pipe-424209-r1/alm-app/alm-app:${ALM_APP_AMD64_TAG:-amd64-latest}
    container_name: alm_amd64
    ports:
      - "80:80" # Main HTTP traffic for content delivery
    volumes:
      # Configuration files generated by init container
      - alm_config:/opt/alm/config:ro
    environment:
      - HOST_IP_FILE=/host_ip
      - INIT_REQUIRED=true # Wait for init completion before starting
    depends_on:
      alm_init_amd64:
        condition: service_completed_successfully # Wait for init to complete
    restart: unless-stopped # Auto-restart main service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
# ============================================================================
# SHARED VOLUMES FOR CONFIGURATION MANAGEMENT
# ============================================================================
volumes:
  # Main configuration volume (shared between init and main containers)
  # Docker-managed named volume - no host directories needed!
  alm_config:
  # Persistent data volume for device-specific information
  # Docker-managed named volume - no host directories needed!
  alm_persist:

# ============================================================================
# DEPLOYMENT NOTES - ZERO HOST SETUP REQUIRED!
# ============================================================================
#
# ZERO-SETUP DEPLOYMENT:
# 1. Copy docker-compose.yml to any directory (e.g., ~/alm/)
# 2. Run: docker compose up -d alm_arm64  (for ARM64/RPi)
# 3. That's it! No host directories, no manual setup needed.
#
# ARCHITECTURE SELECTION:
# - ARM64 (Raspberry Pi): docker compose up -d alm_arm64
# - AMD64 (Servers): docker compose up -d alm_amd64
#
# CONTAINER COMMUNICATION:
# - Init containers expose port 8080 for web registration
# - Main containers expose port 80 for content delivery
# - Configuration sharing via Docker named volumes (no host paths!)
#
# CONFIGURATION FLOW:
# 1. Init container generates configs in Docker volume 'alm_config'
# 2. Main container reads configs from same Docker volume
# 3. All data persisted in Docker volume 'alm_persist'
# 4. Zero host filesystem involvement!
#
# NETWORK DISCOVERY:
# - Devices discoverable via hostname.local:8080
# - Multiple fallback discovery methods available
# ============================================================================
